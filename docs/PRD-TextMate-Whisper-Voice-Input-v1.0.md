# PRD：TextMate 语音输入增强（Whisper-MLX）

- 文档版本：v1.0
- 文档日期：2026-02-24
- 作者：用户项目协作 Agent
- 目标读者：用户、实现同学、评审同学

## 1. 背景与问题

当前 TextMate 的写作流以键盘输入为主。用户已在本地具备 `mlx_whisper` 能力，希望将语音转文字直接接入 TextMate，形成“语音->文字->编辑”的高效率工作流。

现有痛点：
1. 无原生语音输入能力。
2. 外部录音转写流程割裂，打断写作专注。
3. 语音识别结果如何安全进入正文（避免误替换）缺乏统一规范。

## 2. 产品目标

### 2.1 目标（Goals）

1. 在 TextMate 中实现一键语音输入，默认插入到光标位置。
2. 支持“替换选区”与“插入光标”两种落地模式。
3. 本地运行（Whisper-MLX），不依赖云端语音服务。
4. 失败可诊断（设备、权限、模型、命令不可用）。
5. 支持快捷键驱动，符合写作高频操作。

### 2.2 非目标（Non-Goals）

1. 不实现实时连续流式字幕级别 UI。
2. 不改 TextMate 核心源码。
3. 不在 v1 处理复杂语音命令（如“删除上一句”）。
4. 不引入聊天式对话窗口。

## 3. 用户画像与场景

### 3.1 用户画像

1. 高频 Markdown 写作者。
2. 已安装 TextMate + 本地 MLX Whisper 环境。
3. 接受快捷键和命令式交互。

### 3.2 核心场景

1. 灵感速记：想到一句话立即口述插入。
2. 段落草稿：语音输入一段后再手工润色。
3. 选区改写：选中段落后口述替换内容。

## 4. 核心流程

### 4.1 MVP 主流程（固定时长录音）

1. 用户触发命令（快捷键）。
2. 脚本录音 N 秒（默认 20 秒）。
3. 调用 `mlx_whisper` 转写生成文本。
4. 文本返回 TextMate。
5. 按命令输出策略执行：
   - Insert: 插入光标处
   - Replace: 替换当前选区

### 4.2 安全流程（推荐）

1. 用户触发“语音输入（预览）”。
2. 转写结果先展示在新文档/临时窗口。
3. 用户确认后再应用到正文（避免误污染）。

## 5. 功能需求（Functional Requirements）

### FR-1 命令能力

1. `Voice Input: Insert at Cursor`
2. `Voice Input: Replace Selection`
3. `Voice Input: Preview then Apply`（可选增强）

### FR-2 录音能力

1. 使用 `ffmpeg`（avfoundation）录制麦克风。
2. 支持配置录音时长（默认 20 秒，范围 5-120 秒）。
3. 默认单声道 16k 采样，降低识别负担。

### FR-3 转写能力

1. 调用本地 `mlx_whisper`。
2. 支持配置模型（tiny/base/small 等）。
3. 支持语言参数（默认 `zh`，可 auto）。
4. 输出 `txt` 为主。

### FR-4 文本落地能力

1. 插入模式：直接插入光标处。
2. 替换模式：替换当前选区。
3. 失败模式：不改正文，只提示错误。

### FR-5 配置能力

通过 `~/.tm_properties` 或项目 `.tm_properties` 提供：

1. `TM_WHISPER_BIN`（默认 `mlx_whisper`）
2. `TM_WHISPER_MODEL`（默认 `mlx-community/whisper-small`）
3. `TM_WHISPER_LANG`（默认 `zh`）
4. `TM_WHISPER_MAX_SEC`（默认 `20`）
5. `TM_FFMPEG_BIN`（默认 `ffmpeg`）

## 6. 非功能需求（NFR）

1. 启动到结果返回：短语音场景下可接受（目标 < 8 秒，不含长录音）。
2. 脚本稳定：异常退出不污染正文。
3. 可观测：错误信息可定位到“录音/转写/文件/权限”环节。
4. 可回滚：卸载命令即可恢复原编辑体验。

## 7. 交互与快捷键建议

1. `⌥⌘D`：语音输入（插入）
2. `⇧⌥⌘D`：语音输入（替换选区）
3. `⌃⌥⌘D`：语音输入（预览）

说明：最终快捷键需避开现有 Bundle 冲突。

## 8. 技术方案概述

### 8.1 组件

1. TextMate `.tmCommand`（入口）
2. Shell 脚本（录音 + 调 Whisper + 清洗输出）
3. 本地依赖：`ffmpeg`、`mlx_whisper`

### 8.2 数据流

1. 触发命令
2. 录音文件生成到 `/tmp`
3. 转写结果输出为 `txt`
4. stdout 回传 TextMate
5. 根据输出策略写入编辑区

### 8.3 临时文件策略

1. 录音临时文件：`/tmp/tm-whisper-*.wav`
2. 转写目录：`/tmp/tm-whisper-out-*`
3. 命令结束后清理

## 9. 异常处理

1. 找不到 `mlx_whisper`：提示安装路径或 `TM_WHISPER_BIN`。
2. 找不到 `ffmpeg`：提示安装。
3. 麦克风权限拒绝：提示去 macOS 隐私设置开启。
4. 录音设备不可用：提示检查 avfoundation 设备号。
5. 转写为空：提示重试（环境噪音或时长不足）。

## 10. 隐私与安全

1. 全流程本地执行，不上传音频。
2. 默认不保留音频临时文件。
3. 若开启调试日志，需提示用户可能含敏感文本。

## 11. 里程碑计划

### M1（1 天）

1. 跑通固定时长录音 + 转写 + 插入。
2. 支持基础配置项。

### M2（1 天）

1. 增加替换选区命令。
2. 增加预览再应用命令。

### M3（0.5-1 天）

1. 健壮性与报错优化。
2. 快捷键冲突整理与文档化。

## 12. 验收标准（Acceptance Criteria）

1. 在 TextMate 中可通过快捷键触发语音输入。
2. 插入模式正确把识别结果写入光标处。
3. 替换模式仅替换选区，不影响其他文本。
4. 依赖缺失时给出明确提示且不改正文。
5. 同一命令连续执行 20 次无崩溃。

## 13. 风险与缓解

1. 识别延迟：默认使用小模型，允许用户手动升降模型。
2. 麦克风兼容：提供设备检测说明与可配置输入源。
3. 误识别污染正文：默认推荐“预览再应用”模式。

## 14. 实施边界

1. 首版只做 macOS + TextMate + 本地 MLX Whisper。
2. 不承诺跨平台一致行为。
3. 不承诺实时语音流式输入。

## 15. 后续演进（v1.1+）

1. 支持“开始录音/停止录音”双命令。
2. 支持段落级自动标点优化。
3. 支持“语音输入后自动调用写作润色动作”。

---

## 附录 A：建议默认配置

```properties
TM_WHISPER_BIN = mlx_whisper
TM_WHISPER_MODEL = mlx-community/whisper-small
TM_WHISPER_LANG = zh
TM_WHISPER_MAX_SEC = 20
TM_FFMPEG_BIN = ffmpeg
```

## 附录 B：实现完成定义（DoD）

1. 命令可安装、可触发、可回退。
2. 有 README 使用说明。
3. 有最小冒烟验证脚本（录音 3 秒转写）。
